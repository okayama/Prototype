<mt:include file="include/header.tmpl">

<mt:var name="model" setvar="_model">
<mt:setvar name="_primary" value="">

<mt:if name="request.edit_revision">
  <div id="alert-revision" class="alert alert-success" tabindex="0">
    <mt:var name="alert_close">
    <mt:trans phrase="You are about to edit the revision. To apply this revision to the master click the 'Apply to Master' button.">
  </div>
<script>
$('#alert-revision').focus();
</script>
</mt:if>

<mt:if name="request.apply_to_master">
  <div id="alert-saved" class="alert alert-info" tabindex="0">
    <mt:var name="alert_close">
    <mt:trans phrase="Revision applied to master.">
  </div>
<script>
$('#alert-saved').focus();
</script>
<mt:elseif name="request.saved">
  <div id="alert-saved" class="alert alert-success" tabindex="0">
    <mt:var name="alert_close">
    <mt:trans phrase="Your changes have been saved.">
  </div>
<script>
$('#alert-saved').focus();
</script>
</mt:if>
</mt:if>

<mt:setvarblock name="field_required">
  <i class="fa fa-asterisk required" aria-hidden="true"></i>
  <span class="sr-only"><mt:trans phrase="Required"></span>
</mt:setvarblock>

<form action="<mt:var name="script_uri">" method="POST" id="edit-form-main">

<mt:setvarblock name="include_path">include/edit/<mt:var name="model">/form_header.tmpl</mt:setvarblock>
<mt:include file="$include_path">

<input type="hidden" name="__mode" value="save" id="__mode">
<input type="hidden" name="_model" value="<mt:var name="model">">
<input type="hidden" name="magic_token" value="<mt:var name="magic_token">">
<input type="hidden" name="_screen_id" value="<mt:var name="screen_id">">
<input type="hidden" name="workspace_id" value="<mt:var name="workspace_id">">
<input type="hidden" name="_type" value="edit">
<input type="hidden" name="_preview" id="_preview" value="">
<mt:if name="request.edit_revision">
<input type="hidden" name="_edit_revision" value="1">
<input type="hidden" name="_apply_to_master" id="_apply_to_master" value="">
</mt:if>
<mt:if name="_revisable">
<input type="hidden" name="_save_as_revision" id="_save_as_revision" value="">
</mt:if>
<mt:objectcontext>
<mt:objectcols type="edit">
<mt:var name="name" setvar="_column_name">

<mt:if name="type" ne="relation">
<mt:objectvar name="$_column_name" escape setvar="value">
</mt:if>

<mt:if name="_column_name" eq="primary">
  <mt:setvar name="_primary_" value="$value">
</mt:if>

<mt:var name="name" escape setvar="__col_name__">
<mt:var name="value" escape setvar="__col_value__">

<mt:setvar name="ctrl_class" value="">
<mt:if name="edit" like="num">
  <mt:setvar name="ctrl_class" value="e-num">
<mt:elseif name="edit" like="short">
  <mt:setvar name="ctrl_class" value="short">
</mt:if>

<mt:setvar name="readonly" value="0">
<mt:if name="name" eq="modified_on">
  <mt:setvar name="readonly" value="1">
<mt:elseif name="name" eq="created_on">
  <mt:setvar name="readonly" value="1">
<mt:elseif name="autoset">
  <mt:setvar name="readonly" value="1">
</mt:if>

<mt:if name="unchangeable">
  <mt:if name="request.id">
    <mt:setvar name="readonly" value="1">
  </mt:if>
</mt:if>

<mt:includeparts screen="edit" type="column" name="$_column_name" model="$model" setvar="_include_column">

<mt:if name="__col_name__" ne="id">
<div id="<mt:var name="__col_name__">-wrapper">
</mt:if>

<mt:if name="_include_column">
  <mt:var name="_include_column">

<mt:elseif name="edit" eq="hidden">
    <input id="<mt:var name="__col_name__">" type="hidden" name="<mt:var name="__col_name__">" value="<mt:var name="value">">
<mt:elseif name="edit" eq="primary">

<mt:setvar name="_primary" value="$value">
<mt:setvar name="_languages" value="$languages">

<div class="row form-group">
  <div class="col-lg-2">
    <label for="<mt:var name="__col_name__">">
      <mt:var name="label" escape>
      <mt:if name="not_null"><mt:var name="field_required"></mt:if>
    </label>
  </div>
  <div class="col-lg-10 input-group-lg">
    <input id="<mt:var name="__col_name__">" type="text" class="form-control watch-changed" name="<mt:var name="__col_name__">" value="<mt:var name="value">"
      aria-label="<mt:var name="label" escape>" placeholder="<mt:var name="label" escape>" <mt:if name="readonly">readonly</mt:if>>
  <mt:if name="permalink">
  <div class="input-group copy-url copy-url-permalink">
  <input type="text" class="form-control form-control-sm clipboard-url" id="__permalink-clipboard"
  value="<mt:var name="permalink">">
  <button data-toggle="tooltip" data-placement="left" title="<mt:trans phrase="Copy to Clipboard">" type="button" class="input-group-addon copy-clipboard" data-clipboard-target="#__permalink-clipboard"><i class="fa fa-clipboard" aria-hidden="true" aria-label="<mt:trans phrase="Copy to Clipboard">"></i></button>
  <button id="__view-permalink" data-toggle="tooltip" data-placement="left" title="<mt:trans phrase="View">" type="button" class="input-group-addon copy-clipboard"><i class="fa fa-external-link" aria-hidden="true" aria-label="<mt:trans phrase="View">"></i></button>
  </div>
  <mt:setvar name="permalink" value="">
<script>
$('#__view-permalink').click(function(){
    var permalink = $('#__permalink-clipboard').val();
    window.open( permalink, '_blank');
});
</script>
  </mt:if>
  </div>
</div>

<mt:elseif name="edit" eq="languages">
<!--TODO-->
<div class="row form-group">
  <div class="col-lg-2">
    <label for="<mt:var name="__col_name__">">
      <mt:var name="label" escape>
      <mt:if name="not_null"><mt:var name="field_required"></mt:if>
    </label>
  </div>
  <div class="col-lg-2">
    <mt:loop name="_languages">
    <mt:if name="__first__">
    <select class="form-control short" id="<mt:var name="__col_name__">" name="<mt:var name="__col_name__">" <mt:if name="readonly"></mt:if>>
    </mt:if>
      <option value="<mt:var name="__value__">" <mt:if name="value" eq="$__value__">selected</mt:if>><mt:var name="__value__"></option>
    <mt:if name="__last__">
    </select>
    </mt:if>
    </mt:loop>
  </div>
</div>

<mt:elseif name="edit" eq="file">

<div class="row form-group">
  <div class="col-lg-2">
    <label for="<mt:var name="__col_name__">">
      <mt:var name="label" escape>
      <mt:if name="not_null"><mt:var name="field_required"></mt:if>
    </label>
  </div>
  <div class="col-lg-10 input-group-lg">

<mt:assetproperty name="$name" model="$model" property="class" setvar="class">

<mt:assetproperty name="$name" model="$model" property="url" setvar="asset_url">

<mt:assetthumbnail type="default" name="$name" model="$model" data_uri="1" setvar="thumbnail">
<mt:unlass name="class">
<mt:if name="thumbnail">
  <mt:setvar name="class" value="image">
</mt:if>
</mt:unless>

<mt:setvar name="preview_width" value="128">
<mt:assetproperty name="$name" model="$model" property="image_width" setvar="image_width">
<mt:if name="image_width">
<mt:if name="image_width" lt="$preview_width">
  <mt:setvar name="preview_width" value="$image_width">
</mt:if>
</mt:if>

<mt:assetproperty name="$name" model="$model" property="file_name" setvar="file_name">
<mt:if name="file_name">
<mt:assetproperty name="$name" model="$model" property="url" setvar="asset_url">
<mt:setvarblock name="file_meta">
    <b><mt:trans phrase="Name"></b> :
      <mt:assetproperty name="$name" model="$model" property="file_name"><br>
    <b><mt:trans phrase="Size"></b> :
      <mt:assetproperty name="$name" model="$model" property="file_size" format_size="1"><br>
    <b><mt:trans phrase="Type"></b> :
      <mt:assetproperty name="$name" model="$model" property="mime_type">
    <mt:if name="class" eq="image">
    <br>
    <b><mt:trans phrase="Width"></b> :
      <mt:assetproperty name="$name" model="$model" property="image_width">px<br>
    <b><mt:trans phrase="Height"></b> : 
      <mt:assetproperty name="$name" model="$model" property="image_height">px
    </mt:if>
</mt:setvarBlock>
</mt:if>

<mt:ignore>TODO: top of template</mt:ignore>

<mt:setvarblock name="file_meta_tmpl">
    <b><mt:trans phrase="Name"></b> :
      file_name<br>
    <b><mt:trans phrase="Size"></b> :
      file_size<br>
    <b><mt:trans phrase="Type"></b> :
      mime_type
</mt:setvarBlock>
<mt:setvarblock name="file_image_tmpl">
    <br>
    <b><mt:trans phrase="Width"></b> :
      image_widthpx<br>
    <b><mt:trans phrase="Height"></b> : 
      image_heightpx
</mt:setvarBlock>
    <div class="alert alert-success hidden" id="<mt:var name="__col_name__">-alert" role="alert" tabindex="0">
      <button onclick="$('#<mt:var name="__col_name__">-alert').hide();" type="button" id="header-alert-close" class="close" aria-label="<mt:trans phrase="Detach">">
        <span aria-hidden="true">&times;</span>
      </button>
      <span><mt:trans phrase="The file has successfully uploaded. The uploaded file will not be reflected until you save this page."></span>
    </div>

<div id="drop-<mt:var name="__col_name__">">
<i id="icon-<mt:var name="__col_name__">" class="btn fa <mt:if name="class" eq="image">fa-file-image-o<mt:elseif name="class" eq="pdf">fa-file-pdf-o<mt:else>fa-file-o</mt:if> fa-3x" aria-hidden="true"></i>

    <img <mt:unless name="class" eq="image">class="hidden" </mt:unless>id="image_preview-<mt:var name="__col_name__">" src="<mt:var name="thumbnail">" width="<mt:var name="preview_width">" alt="<mt:trans phrase="Preview">">
    <a href="javascript:void(0);"
        id="popover-<mt:var name="__col_name__">"><i class="btn fa fa-info-circle fa-2x" aria-hidden="true" aria-label="<mt:trans phrase="Properties">"></i></a>
    <mt:objectvar name="$name" escape setvar="value">
    <mt:ignore>TODO:not Image</mt:ignore>
      &nbsp; <a id="inline-<mt:var name="__col_name__">" target="_blank" class="btn btn-secondary <mt:unless name="value">hidden</mt:unless>" href="<mt:var name="script_uri">?__mode=view&amp;_type=edit&amp;_model=<mt:var name="model">&amp;id=<mt:var name="request.id" escape>&amp;view=<mt:var name="__col_name__">&amp;_screen_id=<mt:var name="screen_id"><mt:if name="workspace_id">&amp;workspace_id=<mt:var name="workspace_id"></mt:if>"><mt:trans phrase="View"></a>
      <a id="download-<mt:var name="__col_name__">" class="btn btn-secondary <mt:unless name="value">hidden</mt:unless>" href="<mt:var name="script_uri">?__mode=view&amp;_type=edit&amp;_model=<mt:var name="model">&amp;id=<mt:var name="request.id" escape>&amp;view=<mt:var name="__col_name__">&amp;download=1&amp;_screen_id=<mt:var name="screen_id"><mt:if name="workspace_id">&amp;workspace_id=<mt:var name="workspace_id"></mt:if>"><mt:trans phrase="Download"></a>
      <mt:setvarblock name="attach_key">request.<mt:var name="__col_name__">-magic</mt:setvarblock>
    <input id="<mt:var name="__col_name__">-magic" type="hidden" value="<mt:var name="$attach_key" escape>" name="<mt:var name="__col_name__">-magic" class="watch-changed">
    <span class="btn btn-success fileinput-button">
        <i class="glyphicon glyphicon-plus"></i>
        <span><mt:trans phrase="Select File..."></span>
        <!-- The file input field used as target for the file upload widget -->
        <input id="<mt:var name="__col_name__">" type="file" name="files">
    </span>
    <!-- The global progress bar -->
    <div id="progress-<mt:var name="__col_name__">" class="progress">
        <div class="progress-bar progress-bar-success"></div>
    </div>
    <!-- The container for the uploaded files -->
    <div id="files-<mt:var name="__col_name__">" class="files"></div>

<div class="input-group copy-url" id="clipboard-<mt:var name="__col_name__">-wrapper">
  <input type="text" class="form-control form-control-sm clipboard-url" id="clipboard-<mt:var name="__col_name__">"
  value="<mt:if name="asset_url"><mt:var name="asset_url"><mt:else><mt:var name="script_uri">?__mode=view&amp;_type=edit&amp;_model=<mt:var name="model">&amp;id=<mt:var name="request.id" escape>&amp;view=<mt:var name="__col_name__">&amp;_screen_id=<mt:var name="screen_id"><mt:if name="workspace_id">&amp;workspace_id=<mt:var name="workspace_id"></mt:if></mt:if>">
  <button data-toggle="tooltip" data-placement="left" title="<mt:trans phrase="Copy to Clipboard">" type="button" class="input-group-addon copy-clipboard" data-clipboard-target="#clipboard-<mt:var name="__col_name__">"><i class="fa fa-clipboard" aria-hidden="true" aria-label="<mt:trans phrase="Copy to Clipboard">"></i></button>
  <button id="view-<mt:var name="__col_name__">" data-toggle="tooltip" data-placement="left" title="<mt:trans phrase="View">" type="button" class="input-group-addon copy-clipboard"><i class="fa fa-external-link" aria-hidden="true" aria-label="<mt:trans phrase="View">"></i></button>
</div>
</div>
<script>
$('#view-<mt:var name="__col_name__">').click(function(){
    var viewlink = $('#clipboard-<mt:var name="__col_name__">').val();
    window.open( viewlink, '_blank');
});
<mt:if name="file_meta">
$('#popover-<mt:var name="__col_name__">').popover({
    title: "<mt:trans phrase="Properties">",
    content: "<mt:var name="file_meta" strip_linefeeds="1">",
    placement: "right",
    html: true
});
<mt:else>
    $('#popover-<mt:var name="__col_name__">').hide();
    $('#clipboard-<mt:var name="__col_name__">-wrapper').hide();
</mt:if>
var DropZone<mt:var name="__col_name__"> = document.getElementById('drop-<mt:var name="__col_name__">');
DropZone<mt:var name="__col_name__">.addEventListener('dragover', function (event) {
    $('#drop-<mt:var name="__col_name__">').css('background-color','#ddf');
});
DropZone<mt:var name="__col_name__">.addEventListener('dragleave', function (event) {
    $('#drop-<mt:var name="__col_name__">').css('background-color','#fff');
});
$('#drop-<mt:var name="__col_name__">').css('border','3px dashed #ccc');
$('#drop-<mt:var name="__col_name__">').css('margin','1px');
$('#drop-<mt:var name="__col_name__">').css('padding','8px');
/*jslint unparam: true */
/*global window, $ */
$(function () {
    'use strict';
    var url = '<mt:var name="script_uri">?__mode=upload&_model=<mt:var name="model">&_screen_id=<mt:var name="screen_id">&name=<mt:var name="__col_name__">';
    $('#<mt:var name="__col_name__">').fileupload({
        url: url,
        dataType: 'json',
        dropZone: $("#drop-<mt:var name="__col_name__">"),
        done: function (e, data) {
            if (!data.result.files) {
                var error = data.result.message;
                $('#progress-<mt:var name="__col_name__"> .progress-bar').css(
                    'width', 0
                );
                alert("<mt:trans phrase="An error occurred while uploading.">"+' (' + error + ')');
                return;
            }
            $.each(data.result.files, function (index, file) {
                $('#files-<mt:var name="__col_name__">').html('');
                $('#download-<mt:var name="__col_name__">').show();
                $('#inline-<mt:var name="__col_name__">').show();
                $('#<mt:var name="__col_name__">-magic').val(file.magic);
                // alert(JSON.stringify(file));
                $('<p/>').text(file.name).appendTo('#files-<mt:var name="__col_name__">');
                if (file.class == 'image') {
                    $('#image_preview-<mt:var name="__col_name__">').show();
                    $('#image_preview-<mt:var name="__col_name__">').prop('src','data:'+file.type+';base64,'+file.thumbnail);
                    if(file.width < <mt:var name="preview_width"> ){
                        $('#image_preview-<mt:var name="__col_name__">').prop('width',file.width);
                    } else {
                        $('#image_preview-<mt:var name="__col_name__">').prop('width',150);
                    }
                    $('#icon-<mt:var name="__col_name__">').removeClass('fa-file-pdf-o');
                    $('#icon-<mt:var name="__col_name__">').removeClass('fa-file-o');
                    $('#icon-<mt:var name="__col_name__">').addClass('fa-file-image-o');
                    // fa-file-pdf-o
                } else if (file.class == 'pdf') {
                    $('#icon-<mt:var name="__col_name__">').removeClass('fa-file-o');
                    $('#icon-<mt:var name="__col_name__">').removeClass('fa-file-image-o');
                    $('#icon-<mt:var name="__col_name__">').addClass('fa-file-pdf-o');
                } else {
                    $('#icon-<mt:var name="__col_name__">').removeClass('fa-file-pdf-o');
                    $('#icon-<mt:var name="__col_name__">').removeClass('fa-file-image-o');
                    $('#icon-<mt:var name="__col_name__">').addClass('fa-file-o');
                }
                if (file.class != 'image') {
                    $('#image_preview-<mt:var name="__col_name__">').hide();
                }
                var file_size = file.size;
                if ( file_size >= 1048576 ) {
                    file_size = Math.round( ( file_size / 1048576 )*10 )/10 + 'MB';
                } else if ( file_size >= 1024 ) {
                    file_size = Math.round( ( file_size / 1024 )*10 )/10 + 'KB';
                } else {
                    file_size = file_size + 'Byte';
                }
                var prop_tmpl = '<mt:var name="file_meta_tmpl" strip_linefeeds="1">';
                prop_tmpl = prop_tmpl.replace('file_name', file.name);
                prop_tmpl = prop_tmpl.replace('file_size', file_size);
                prop_tmpl = prop_tmpl.replace('mime_type', file.type);
                var image_tmpl = '<mt:var name="file_image_tmpl" strip_linefeeds="1">';
                if (file.class == 'image') {
                    image_tmpl = image_tmpl.replace('image_width', file.width);
                    image_tmpl = image_tmpl.replace('image_height', file.height);
                    prop_tmpl = prop_tmpl + image_tmpl;
                }
                $('#clipboard-<mt:var name="__col_name__">-wrapper').show();
                $('#popover-<mt:var name="__col_name__">').show();
                $('#popover-<mt:var name="__col_name__">').popover('dispose');
                $('#popover-<mt:var name="__col_name__">').popover({
                    title: "<mt:trans phrase="Properties">",
                    content: prop_tmpl,
                    placement: "right",
                    html: true
                });
                if('<mt:var name="model">' == 'asset' && '<mt:var name="__col_name__">' == 'file' ) {
                    $('#file_name').val(file.name);
                    $('#file_ext').val(file.extension);
                    $('#mime_type').val(file.type);
                    $('#class').val(file.class);
                    $('#size').val(file.size);
                    $('#_object_size').html(file_size);
                    if (file.class == 'image') {
                        $('#image_width').val(file.width);
                        $('#image_height').val(file.height);
                        $('#_object_width').html(file.width+'px');
                        $('#_object_height').html(file.height+'px');
                    } else {
                        $('#image_width').val('');
                        $('#image_height').val('');
                        $('#_object_width').html('');
                        $('#_object_height').html('');
                    }
                }
                $('#<mt:var name="__col_name__">-alert').show();
                $('#<mt:var name="__col_name__">-alert').focus();
                $('#progress-<mt:var name="__col_name__"> .progress-bar').css(
                    'width', 0
                );
                $('#drop-<mt:var name="__col_name__">').css('background-color','#fff');
            });
        },
        progressall: function (e, data) {
            var progress = parseInt(data.loaded / data.total * 100, 10);
            $('#progress-<mt:var name="__col_name__"> .progress-bar').css(
                'width',
                progress + '%'
            );
        }
    }).prop('disabled', !$.support.fileInput)
        .parent().addClass($.support.fileInput ? undefined : 'disabled');
});
</script>
  </div>
</div>

<mt:elseif name="edit" eq="checkbox">
<div class="row form-group">
  <div class="col-lg-2">
    <mt:if name="not_null"><mt:var name="field_required"></mt:if>
  </div>
  <div class="col-lg-10">
    <input type="hidden" name="<mt:var name="__col_name__">" value="0">
    <label class="custom-control custom-checkbox">
    <input id="<mt:var name="__col_name__">" class="custom-control-input watch-changed"
    <mt:if name="readonly">onclick="return false;"</mt:if>
     type="checkbox" name="<mt:var name="__col_name__">" value="1" <mt:if name="value">checked</mt:if>>
        <span class="custom-control-indicator"></span>
        <span class="custom-control-description"> 
        <mt:var name="label" escape></span>
    </label>
  </div>
</div>

<mt:elseif name="edit" like="color">

<div class="row form-group">
  <div class="col-lg-2">
    <label for="<mt:var name="__col_name__">">
      <mt:var name="label" escape>
      <mt:if name="not_null"><mt:var name="field_required"></mt:if>
    </label>
  </div>
  <div class="col-lg-10">
    <input id="<mt:var name="__col_name__">" type="color" <mt:var name="ctrl_class">" name="<mt:var name="__col_name__">" value="<mt:var name="value">"
      <mt:if name="readonly">readonly</mt:if> class="watch-changed">
  </div>
</div>

<mt:elseif name="edit" like="text">

<mt:if name="edit" eq="textarea">
<div class="row form-group">
  <div class="col-lg-2">
    <label for="<mt:var name="__col_name__">">
      <mt:var name="label" escape>
      <mt:if name="not_null"><mt:var name="field_required"></mt:if>
    </label>
  </div>
  <div class="col-lg-10">
<textarea id="<mt:var name="__col_name__">" rows="<mt:if name="options"><mt:var name="options" escape><mt:else>5</mt:if>"
  class="form-control watch-changed" name="<mt:var name="__col_name__">"
  <mt:if name="readonly">readonly</mt:if>><mt:var name="value"></textarea>
  </div>
</div>

<mt:elseif name="edit" eq="richtext">
<div class="row form-group">
  <div class="col-lg-2">
    <label for="<mt:var name="__col_name__">">
      <mt:var name="label" escape>
      <mt:if name="not_null"><mt:var name="field_required"></mt:if>
    </label>
  </div>
  <div class="col-lg-10">
<textarea id="<mt:var name="__col_name__">" rows="<mt:if name="options"><mt:var name="options" escape><mt:else>10</mt:if>"
  class="form-control richtext" name="<mt:var name="__col_name__">"
  <mt:if name="readonly">readonly</mt:if>><mt:var name="value"></textarea>
  </div>
</div>

<mt:else>
<div class="row form-group">
  <div class="col-lg-2">
    <label for="<mt:var name="__col_name__">">
      <mt:var name="label" escape>
      <mt:if name="not_null"><mt:var name="field_required"></mt:if>
    </label>
  </div>
  <div class="col-lg-10">
  <mt:if name="name" eq="extra_path">
    <mt:unless name="request.id">
      <mt:unless name="workspace_scope">
        <mt:getoption key="extra_path" escape setvar="value">
      <mt:else>
        <mt:var name="workspace_extra_path" escape setvar="value">
      </mt:unless>
    </mt:unless>
  </mt:if>
    <input id="<mt:var name="__col_name__">" type="<mt:if name="disp_option" like="num">number<mt:else>text</mt:if>" class="form-control watch-changed <mt:var name="ctrl_class">" name="<mt:var name="__col_name__">" value="<mt:var name="value">"
      <mt:if name="readonly">readonly</mt:if>>
  </div>
</div>
</mt:if>

<mt:elseif name="edit" like="num">
<div class="row form-group">
  <div class="col-lg-2">
    <label for="<mt:var name="__col_name__">">
      <mt:var name="label" escape>
      <mt:if name="not_null"><mt:var name="field_required"></mt:if>
    </label>
  </div>
  <div class="col-lg-10">
    <input id="<mt:var name="__col_name__">" type="number" class="form-control watch-changed <mt:var name="ctrl_class">" name="<mt:var name="__col_name__">" value="<mt:var name="value">"
      <mt:if name="readonly">readonly</mt:if>>
  </div>
</div>

<mt:elseif name="edit" eq="password">
<div class="row form-group">
  <div class="col-lg-2">
    <label for="<mt:var name="__col_name__">">
    <mt:if name="request.id">
      <mt:trans phrase="New %s" params="$label" escape>
    <mt:else>
      <mt:var name="label" escape>
    </mt:if>
    <mt:unless name="request.id">
    <mt:if name="not_null"><mt:var name="field_required"></mt:if>
    </mt:unless>
    </label>
  </div>
  <div class="col-lg-10">
    <input id="<mt:var name="__col_name__">" type="password" class="form-control watch-changed" name="<mt:var name="__col_name__">" value="">
  </div>
</div>
<div class="row form-group">
  <div class="col-lg-2">
    <label for="<mt:var name="__col_name__">-verify">
    <mt:if name="request.id">
      <mt:trans phrase="New %s (Confirm)" params="$label" escape>
    <mt:else>
      <mt:trans phrase="%s (Confirm)" params="$label" escape>
    </mt:if>
    </label>
  </div>
  <div class="col-lg-10">
    <input id="<mt:var name="__col_name__">-verify" type="password" class="form-control watch-changed" name="<mt:var name="__col_name__">-verify" value="">
  </div>
</div>

<mt:elseif name="edit" eq="datetime">

<div class="row form-group">
  <div class="col-lg-2">
    <label for="<mt:var name="__col_name__">">
      <mt:var name="label" escape>
      <mt:if name="not_null"><mt:var name="field_required"></mt:if>
    </label>
  </div>
  <div class="col-lg-10 form-inline">
    <mt:setvarblock name="date_col_name"><mt:var name="__col_name__">_date</mt:setvarblock>
    <mt:setvarblock name="time_col_name"><mt:var name="__col_name__">_time</mt:setvarblock>
    <input id="<mt:var name="__col_name__">" type="date" class="form-control date watch-changed" name="<mt:var name="__col_name__">_date" value="<mt:if name="value"><mt:var name="value" format_ts="Y-m-d"><mt:else><mt:var name="$date_col_name" escape></mt:if>"
      <mt:if name="readonly">readonly</mt:if>>
    &nbsp;
    <input id="<mt:var name="__col_name__">_time" type="time" step="1" class="form-control time watch-changed" name="<mt:var name="__col_name__">_time" value="<mt:if name="value"><mt:var name="value" format_ts="H:i:s"><mt:else><mt:var name="$time_col_name" escape></mt:if>"
      <mt:if name="readonly">readonly</mt:if>>
  </div>
</div>

<mt:elseif name="edit" like=":">
<div class="row form-group">
  <div class="col-lg-2">
    <label for="<mt:var name="__col_name__">">
      <mt:var name="label" escape>
      <mt:if name="not_null"><mt:var name="field_required"></mt:if>
    </label>
  </div>
  <div class="col-lg-<mt:if name="edit" like="select">3<mt:else>10</mt:if>">
    <mt:if name="edit" like="reference">
    <mt:getobjectname id="$value" type="$edit" escape>
    <input type="hidden" id="<mt:var name="__col_name__">" name="<mt:var name="__col_name__">" value="<mt:var name="value">">
    </mt:if>

    <mt:if name="edit" like="relation">
      <mt:if name="edit" like="__any__">
        <mt:include file="include/edit/relation_any.tmpl">
      <mt:else>
        <mt:var name="edit" split=":" setvar="edit_props">
        <mt:var name="edit_props[1]" setvar="rel_model">
        <mt:var name="edit_props[2]" setvar="rel_col">
        <mt:var name="edit_props[3]" setvar="rel_type">
          <mt:if name="edit" like="radio">
            <mt:if name="rel_type" eq="radio">
              <mt:objectloop model="$rel_model" sort_by="order">
              <mt:if name="__first__">
              <label class="custom-control custom-radio">
                <input class="custom-control-input" type="radio" <mt:unless name="__col_value__">checked</mt:unless> name="<mt:var name="__col_name__">" value="0">
                <span class="custom-control-indicator"></span>
                <span class="custom-control-description"><mt:trans phrase="Unspecified"></span>
              </label>
              </mt:if>
              <label class="custom-control custom-radio">
                <input class="custom-control-input watch-changed" type="radio" <mt:if name="__col_value__" eq="$id">checked</mt:if> name="<mt:var name="__col_name__">" value="<mt:var name="id">">
                <span class="custom-control-indicator"></span>
                <span class="custom-control-description"><mt:var name="$rel_col" escape></span>
              </label>
              </mt:objectloop>
            </mt:if>
          <mt:elseif name="edit" like="select">
            <select class="form-control short watch-changed" name="<mt:var name="__col_name__">">
            <mt:objectloop model="$rel_model" sort_by="order">
            <mt:if name="__first__">
              <option value="">
                <mt:trans phrase="Unspecified">
              </option>
            </mt:if>
              <option <mt:if name="__col_value__" eq="$id">selected</mt:if> value="<mt:var name="id">"><mt:var name="$rel_col" escape></option>
            </mt:objectloop>
            </select>
          <mt:elseif name="edit" like="dialog">
            <mt:if name="type" eq="relation">
              <mt:setvarblock name="__rel_name__">object_<mt:var name="__col_name__"></mt:setvarblock>
              <ul id="<mt:var name="__col_name__">" class="relation-list">
                <li <mt:if name="$__rel_name__">style="display:none" </mt:if>class="badge badge-default badge-relation" id="<mt:var name="__col_name__">-none">
                <mt:trans phrase="(None selected)">
                </li>
                <li class="hidden badge badge-default badge-relation badge-draggable" id="<mt:var name="__col_name__">-tmpl">
                <span><mt:trans phrase="Default"></span>
                <button type="button" class="btn btn-secondary btn-sm close-sm" aria-label="<mt:trans phrase="Detach">" data-name="<mt:var name="__col_name__">">
                  <span aria-hidden="true">&times;</span>
                </button>
                <input type="hidden" name="<mt:var name="__col_name__">[]" value="">
                </li>
              <mt:setvarblock name="selected_ids"><mt:loop name="$__rel_name__" glue=","><mt:var name="__value__"></mt:loop></mt:setvarblock>
              <mt:loop name="$__rel_name__">
                <li class="<mt:var name="__col_name__">-child badge badge-default badge-relation badge-draggable">
                <span><mt:getobjectname id="$__value__" type="$edit" escape></span>
                <button type="button" class="btn btn-secondary btn-sm close-sm" aria-label="<mt:trans phrase="Detach">" data-name="<mt:var name="__col_name__">">
                  <span aria-hidden="true">&times;</span>
                </button>
                <input type="hidden" name="<mt:var name="__col_name__">[]" value="<mt:var name="__value__" escape>"></li>
              </mt:loop>
              </ul>
              <button type="button" class="btn btn-primary btn-sm dialog-chooser" data-toggle="modal" data-target="#modal"
                data-href="<mt:var name="script_uri">?__mode=view&amp;_type=list&amp;_model=<mt:var name="rel_model" escape><mt:if name="workspace_id">&amp;workspace_id=<mt:var name="workspace_id"></mt:if>&amp;dialog_view=1&amp;target=<mt:var name="__col_name__">&amp;get_col=<mt:var name="rel_col" escape>&amp;selected_ids=<mt:var name="selected_ids" escape>"><mt:trans phrase="Select..."></button>

              <button type="button" class="btn btn-primary btn-sm dialog-chooser" data-toggle="modal" data-target="#modal"
                data-href="<mt:var name="script_uri">?__mode=view&amp;_type=list&amp;_model=<mt:var name="rel_model" escape><mt:if name="workspace_id">&amp;workspace_id=<mt:var name="workspace_id"></mt:if>&amp;dialog_view=1&amp;target=<mt:var name="__col_name__">&amp;get_col=<mt:var name="rel_col" escape>&amp;selected_ids=<mt:var name="selected_ids" escape>&amp;select_add=1"><mt:trans phrase="Add..."></button>
              <script>
                  $('#<mt:var name="__col_name__">').sortable ( {
                  // TODO keyboard oparation
                      stop: function( evt, ui ) {
                          editContentChanged = true;
                      }
                  });
              </script>
            <mt:else>
              <mt:setvar name="thumbnail" value="">
              <mt:getobjectname id="$__col_value__" type="$edit" wants="id" escape setvar="__col_value__">
              <mt:assetthumbnail id="$__col_value__" type="default" square="1" model="$rel_model" data_uri="1" setvar="thumbnail">
              <img src="<mt:var name="thumbnail">" id="<mt:var name="__col_name__">-img" class="<mt:unless name="thumbnail">hidden</mt:unless>" alt="<mt:trans phrase="Preview">" width="80">
              <span class="badge badge-default badge-relation">
              <span id="<mt:var name="__col_name__">-label">
              <mt:if name="__col_value__">
                <mt:getobjectname id="$__col_value__" type="$edit" escape>
              <mt:else>
                <mt:trans phrase="(None selected)">
              </mt:if>
              </span>
                <button id="<mt:var name="__col_name__">-close" type="button" class="btn btn-secondary btn-sm close-sm<mt:unless name="__col_value__"> hidden</mt:unless>" aria-label="<mt:trans phrase="Detach">" data-name="<mt:var name="__col_name__">">
                  <span aria-hidden="true">&times;</span>
                </button>
              </span>
              <input id="<mt:var name="__col_name__">" type="hidden" name="<mt:var name="__col_name__">" value="<mt:var name="__col_value__" escape>">
              <button type="button" class="btn btn-primary btn-sm dialog-chooser" data-toggle="modal" data-target="#modal"
                data-href="<mt:var name="script_uri">?__mode=view&amp;_type=list&amp;_model=<mt:var name="rel_model" escape><mt:if name="workspace_id">&amp;workspace_id=<mt:var name="workspace_id"></mt:if>&amp;dialog_view=1&amp;single_select=1&amp;target=<mt:var name="__col_name__">&amp;get_col=<mt:var name="rel_col" escape>&amp;selected_ids=<mt:ignore>todo<mt:var name="__col_value__" escape></mt:ignore>"><mt:trans phrase="Select..."></button>
            </mt:if>
          <mt:elseif name="edit" like="checkbox">
            <mt:setvarblock name="__rel_name__">object_<mt:var name="__col_name__"></mt:setvarblock>
            <mt:objectloop model="$rel_model" sort_by="order">
                <label class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input watch-changed" name="<mt:var name="__col_name__">[]" value="<mt:var name="id">" <mt:ifinarray array="$__rel_name__" value="$id">checked</mt:ifinarray>>
                  <span class="custom-control-indicator"></span>
                  <span class="custom-control-description"><mt:var name="$rel_col" escape></span>
                </label>
            </mt:objectloop>
          </mt:if>
      </mt:if>
    </mt:if>
  </div>
</div>
<mt:elseif name="edit" like="selection">

<mt:var name="options" split="," setvar="_options_loop">
<div class="row form-group">
  <div class="col-lg-2">
    <label for="<mt:var name="__col_name__">">
      <mt:var name="label" escape="1">
      <mt:if name="not_null"><mt:var name="field_required"></mt:if>
    </label>
  </div>
  <div class="col-lg-<mt:if name="disp_edit" eq="select">3<mt:else>10</mt:if>">
    <mt:if name="disp_edit" eq="checkbox">
    <mt:var name="__col_value__" split="," setvar="_options_arr">
    <mt:loop name="_options_loop">
        <label class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input watch-changed" name="<mt:var name="__col_name__">[]" value="<mt:var name="__value__" escape>" <mt:ifinarray value="$__value__" array="$_options_arr">checked</mt:ifinarray>>
          <span class="custom-control-indicator"></span>
          <span class="custom-control-description"> <mt:trans phrase="$__value__" escape></span>
        </label>
    </mt:loop>
    <mt:elseif name="disp_edit" eq="radio">
    <mt:loop name="_options_loop">
      <mt:if name="__first__">
      <label class="custom-control custom-radio">
        <input class="custom-control-input watch-changed" type="radio" <mt:unless name="__col_value__">checked</mt:unless> name="<mt:var name="__col_name__">" value="0">
        <span class="custom-control-indicator"></span>
        <span class="custom-control-description"><mt:trans phrase="Unspecified"></span>
      </label>
      </mt:if>
      <mt:if name="options">
      <label class="custom-control custom-radio">
        <input class="custom-control-input watch-changed" type="radio" <mt:if name="__col_value__" eq="$__value__">checked</mt:if> name="<mt:var name="__col_name__">" value="<mt:var name="__value__" escape>">
        <span class="custom-control-indicator"></span>
        <span class="custom-control-description"><mt:trans phrase="$__value__" escape></span>
      </label>
      </mt:if>
    </mt:loop>
    <mt:elseif name="disp_edit" eq="select">
    <select class="form-control short watch-changed" name="<mt:var name="__col_name__">">
    <mt:loop name="_options_loop">
      <mt:if name="__first__">
        <option value="">
          <mt:trans phrase="Unspecified">
        </option>
      </mt:if>
        <option <mt:if name="__col_value__" eq="$__value__">selected</mt:if> value="<mt:var name="__value__" escape>"><mt:trans phrase="$__value__" escape></option>
    </mt:loop>
    </select>
    </mt:if>
  </div>
</div>

<mt:else>
</mt:if>

<mt:if name="__col_name__" ne="id">
</div>
</mt:if>

<mt:if name="__last__">

<mt:if name="_revisable">
<mt:var name="object_rev_object_id" setvar="object_rev_object_id">
<input type="hidden" name="rev_object_id" value="<mt:var name="object_rev_object_id">">
<input type="hidden" name="rev_type" value="<mt:var name="object_rev_type">">
</mt:if>

<mt:setvarblock name="modified_col">
  <div class="col-lg-2">
    <mt:trans phrase="Modified">
  </div>
  <div class="col-lg-2">
    <mt:getobjectname id="$object_modified_by" type="reference:user:nickname" escape>
  </div>
  <div class="col-lg-8">
       <mt:var name="object_modified_on">
<mt:if name="_revision_count">
&nbsp; <i class="fa fa-code-fork" aria-hidden="true"></i> <mt:trans phrase="%s revision(s)" params="$_revision_count">
          <button type="button" class="btn btn-primary btn-sm dialog-chooser" data-toggle="modal" data-target="#modal"
            data-href="<mt:var name="script_uri">?__mode=view&amp;_type=list&amp;_model=<mt:var name="model"><mt:if name="workspace_id">&amp;workspace_id=<mt:var name="workspace_id"></mt:if>&amp;dialog_view=1&amp;single_select=1&amp;revision_select=1&amp;rev_object_id=<mt:var name="object_id" escape>"><mt:trans phrase="Select..."></button>
          <a target="_blank" class="btn btn-secondary btn-sm dialog-chooser"
            href="<mt:var name="script_uri">?__mode=view&amp;_type=list&amp;_model=<mt:var name="model"><mt:if name="workspace_id">&amp;workspace_id=<mt:var name="workspace_id"></mt:if>&amp;revision_select=1&amp;rev_object_id=<mt:var name="object_id" escape>">
            <i class="fa fa-external-link-square" aria-hidden="true"></i>
            <span class="sr-only"><mt:trans phrase="Manage"></span>
          </a>
</mt:if>
  </div>
</mt:setvarblock>

<mt:if name="_auditing">
<div class="row form-group">
  <div class="col-lg-2">
    <mt:trans phrase="Created">
  </div>
  <div class="col-lg-2">
    <mt:unless name="object_created_by">
      <mt:if name="request.id">
        <mt:trans phrase="System">
      </mt:if>
    <mt:else>
      <mt:getobjectname id="$object_created_by" type="reference:user:nickname" escape>
    </mt:unless>
  </div>
  <div class="col-lg-8">
     <mt:var name="object_created_on">
  </div>
</div>

<div class="row form-group">
  <mt:var name="modified_col">
</div>

<mt:if name="_revisable">
<div class="row form-group">
  <div class="col-lg-2">
    <mt:trans phrase="Change Note">
  </div>
  <div class="col-lg-10">
    <input type="text" class="form-control form-control-sm watch-changed" name="rev_note" value="<mt:var name="object_rev_note">">
  </div>
</div>
</mt:if>

</mt:if>
</mt:if>
</mt:objectcols>
</mt:objectcontext>

<hr>

<mt:setvarblock name="include_path">include/edit/<mt:var name="model">/form_footer.tmpl</mt:setvarblock>
<mt:include file="$include_path">

<div class="row form-group">
  <div class="col-lg-12">
  <mt:if name="request.id">
    <mt:if name="can_delete">
      <button type="submit" id="__delete" class="btn btn-secondary"><mt:trans phrase="Delete"></button>
    </mt:if>
  </mt:if>
    <button type="submit" id="__save" class="btn btn-primary"><mt:trans phrase="Save"></button>
  <mt:if name="has_mapping">
    <button type="submit" id="__preview" class="btn btn-secondary"><mt:trans phrase="Preview"></button>
  </mt:if>

<mt:if name="_revisable">
  <mt:if name="request.edit_revision">
    <button type="submit" id="__apply_to_master" class="btn btn-secondary btn-sm"><mt:trans phrase="Apply to Master"></button>
  </mt:if>
  <mt:if name="request.id">
    <button type="submit" id="__save_as_revision" class="btn btn-secondary btn-sm"><mt:trans phrase="Save as Revision"></button>
  </mt:if>
</mt:if>

<mt:if name="request.id">
  <mt:if name="model" eq="table">
    <button type="submit" id="__export" class="btn btn-danger btn-sm"><mt:trans phrase="Export"></button>
  </mt:if>
</mt:if>

  </div>
</div>

<script>
var editContentChanged = false;
$('.watch-changed').change(function(){
    editContentChanged = true;
});
$(function(){
    $(window).on('beforeunload', function() {
        if (! editContentChanged ) {
            $(window).off('beforeunload');
            return;
        }
        return '<mt:trans phrase="Are you sure you want to move from this page? The changes you made are not reflected.">';
    });
});
$('#__preview').click(function(){
    $('#_preview').val(1);
    $('#edit-form-main').attr('target', '_blank');
});
<mt:if name="model" ne="table">
$('#__save').click(function(){
    $(this).attr('disabled', true);
    $('#_preview').val('');
    $('#edit-form-main').removeAttr('target');
    $(window).off('beforeunload');
    $('#edit-form-main').submit();
});
</mt:if>
$('#__delete').click(function(){
    $('#_preview').val('');
    $('#edit-form-main').removeAttr('target');
    $(window).off('beforeunload');
});
<mt:if name="_revisable">
$('#__save_as_revision').click(function(){
    if(!confirm('<mt:trans phrase="Are you sure you want to save this %s as a revision instead of a master?" params="$label">')){
        return false;
    }
    $('#_preview').val('');
    $('#edit-form-main').removeAttr('target');
    $(window).off('beforeunload');
    $('#_save_as_revision').val('1');
});
<mt:if name="request.edit_revision">
$('#__apply_to_master').click(function(){
    if(!confirm('<mt:trans phrase="Are you sure you want to apply this revision to master?">')){
        return false;
    }
    $('#_preview').val('');
    $('#edit-form-main').removeAttr('target');
    $(window).off('beforeunload');
    $('#id').val('<mt:var name="object_rev_object_id">');
    $('#_apply_to_master').val('1');
});
</mt:if>
</mt:if>
</script>
<mt:if name="model" eq="table">
  <mt:if name="request.id">
<script>
var error_message;
$('#__save').click(function(){
    $('#_preview').val('');
    $('#edit-form-main').removeAttr('target');
    $(window).off('beforeunload');
    $('#__validation').val('1');
    $('#__mode').prop('value', 'save');
    var str = $('#edit-form-main').serialize();
    $.post('<mt:var name="script_uri">', str,
        function ( data ) {
            if ( data.status == 500 ) {
                error_message = data.error;
                setTimeout(ajax_failed, 1);
                return;
            }
            $('#__validation').val('');
            $('#__save').attr('disabled', true);
            $('#edit-form-main').submit();
        },
        'json'
    );
    return false;
});
function ajax_failed () {
    alert('<mt:trans phrase="An error occurred.">'+error_message);
}
</script>
<mt:else>
<script>
$('#__save').click(function(){
    $(this).attr('disabled', true);
    $(window).off('beforeunload');
    $('#edit-form-main').submit();
});
</script>
  </mt:if>
</mt:if>
</form>

<div id="modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modal" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
        <iframe></iframe>
    </div>
  </div>
</div>

<script>
$('.badge-draggable').mouseenter(function() {
    $(this).css('cursor','move');
});
$(function () {
    var clipboard = new Clipboard('.copy-clipboard');
    $('[data-toggle="tooltip"]').tooltip();
});
$('.close-sm').click(function(){
    if(!confirm('<mt:trans phrase="Are you sure you want to detach this relation?">')){
        return false;
    }
    id = $(this).prop('id');
    if ( id ) {
        var spl = id.split('-');
        $('#' + spl[0] + '-label').html('<mt:trans phrase="(None selected)">');
        $('#' + spl[0] + '-img').hide();
        $('#' + spl[0]).val('');
        $(this).hide();
        return false;
    }
    name = $(this).attr('data-name');
    counter = 0;
    $('#'+name).children('li').each(function(){
        if (! $(this).prop('id') ) {
            counter++;
        }
    });
    if ( counter == 1 ) {
        $('#'+name+'-none').show();
    }
    $(this).parent().remove();
});
$('#__delete').click(function(){
    if(! confirm('<mt:trans phrase="Are you sure you want to remove %s?" params="$label">')){
        return false;
    }
    $('#__mode').prop('value', 'delete');
});
$('#__export').click(function(){
    if(! confirm('<mt:trans phrase="Are you sure you want to export %s?" params="$label">')){
        return false;
    }
    $('#__mode').prop('value', 'export_scheme');
});
</script>
<!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
<script src="assets/js/vendor/jquery.ui.widget.js"></script>
<!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
<script src="assets/js/jquery.iframe-transport.js"></script>
<!-- The basic File Upload plugin -->
<script src="assets/js/jquery.fileupload.js"></script>
<script>
<mt:objectcontext>
<mt:objectcols type="edit">
  <mt:if name="name" ne="id">
    <mt:setvar name="_checked" value="0">
    <mt:if name="edit" eq="primary"><mt:setvar name="_checked" value="1"></mt:if>
    <mt:ifinarray array="$display_options" value="$name">
      <mt:setvar name="_checked" value="1">
    </mt:ifinarray>
    <mt:unless name="_checked">
$('#<mt:var name="__col_name__">-wrapper').hide();
    </mt:unless>
  </mt:if>
</mt:objectcols>
</mt:objectcontext>
</script>

<mt:setvarblock name="include_path">include/edit/<mt:var name="model">/footer.tmpl</mt:setvarblock>
<mt:include file="$include_path">
<mt:include file="include/footer.tmpl">