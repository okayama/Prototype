<mt:trans phrase="Import Entries" component="EntryImporter" setvar="page_title">
<mt:include file="include/header.tmpl">

<mt:unless name="request.do_import">

<form action="<mt:var name="script_uri">" method="POST" id="import-form">
<input type="hidden" name="__mode" value="import_entry">
<input type="hidden" name="magic_token" value="<mt:var name="magic_token">">
<input type="hidden" name="workspace_id" value="<mt:var name="workspace_id">">
<input type="hidden" name="magic" value="" id="magic">
<input type="hidden" name="do_import" value="1">
<div class="row form-group">
  <div class="col-lg-2">
    <label for="import_format">
    <mt:trans phrase="Format">
    </label>
  </div>
  <div class="col-lg-3 form-inline">
    <mt:loop name="importer_loop">
    <mt:if name="__first__">
    <select class="form-control" id="import_format" name="import_format">
      <option value=""><mt:trans phrase="(None selected)"></option>
    </mt:if>
      <option value="<mt:var name="key">"><mt:var name="label"></option>
    <mt:if name="__last__">
    </select>
    </mt:if>
    </mt:loop>
  </div>
  </div>
<div class="row form-group">
  <div class="col-lg-2">
    <label for="fileupload">
    <mt:trans phrase="File">
    </label>
  </div>
  <div class="col-lg-10 container-fluid">
    <div id="drop-zone">
    <span id="file-chooser" class="btn btn-success fileinput-button">
        <span><mt:trans phrase="Select File..."></span>
        <!-- The file input field used as target for the file upload widget -->
        <input id="fileupload" type="file" name="files"
            onfocus="$('#file-chooser').css('border','2px solid green');"
            onblur="$('#file-chooser').css('border','none');">
    </span>
    <!-- The global progress bar -->
    <div id="progress" class="progress">
        <div class="progress-bar progress-bar-success"></div>
    </div>
    <!-- The container for the uploaded files -->
    <div id="files" class="files"></div>
    </div>
  </div>
</div>

<div class="row form-group">
  <div class="col-lg-2 option-content hidden">
    <mt:trans phrase="Options">
  </div>
  <div class="col-lg-10 option-content hidden">
  <mt:loop name="importer_loop">
  <mt:setvarblock name="option_path">options/<mt:var name="key">.tmpl</mt:setvarblock>
<mt:include file="$option_path" setvar="option_tmpl">
<mt:if name="option_tmpl">
  <div id="<mt:var name="key">-option" class="hidden">
    <mt:var name="option_tmpl">
  </div>
</mt:if>
  </mt:loop>
  </div>
</div>
<hr>
<button type="submit" id="save" class="btn btn-primary disabled" disabled><mt:trans phrase="Do Import" component="EntryImporter"></button>
</form>

<!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
<script src="assets/js/vendor/jquery.ui.widget.js"></script>
<!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
<script src="assets/js/jquery.iframe-transport.js"></script>
<!-- The basic File Upload plugin -->
<script src="assets/js/jquery.fileupload.js"></script>
<script>
var this_url = '<mt:var name="script_uri">?<mt:if name="workspace_id">workspace_id=<mt:var name="workspace_id">&</mt:if><mt:var name="query_string" regex_replace="'/&selected_ids=.*$/',''">&sort=id&direction=desc';
var selected_ids = [];
var DropZone = document.getElementById('drop-zone');
DropZone.addEventListener('dragover', function (event) {
    $('#drop-zone').css('background-color','#ddf');
});
DropZone.addEventListener('dragleave', function (event) {
    $('#drop-zone').css('background-color','#fff');
});
$('#drop-zone').css('border','3px dashed #ccc');
$('#drop-zone').css('padding','12px');
$('.fileinput-button').css('margin','12px 0px');
$(function () {
    'use strict';
    var url = '<mt:var name="script_uri">?__mode=upload_import_file&magic_token=<mt:var name="magic_token">&workspace_id=<mt:var name="workspace_id">';
    $('#fileupload').fileupload({
        url: url,
        dataType: 'json',
        dropZone: $("#drop-zone"),
        formData: {extra_path: $('#import_format').val()},
        done: function (e, data) {
            if (!data.result.files) {
                var error = data.result.message;
                $('#progress .progress-bar').css(
                    'width', 0
                );
                alert("<mt:trans phrase="An error occurred while uploading.">"+' (' + error + ')');
                return;
            }
            $.each(data.result.files, function (index, file) {
                // alert(JSON.stringify(file));
                $('#files').html('');
                $('<p/>').text(file.name).appendTo('#files');
                $('#magic').val(file.magic);
                if ( $('#import_format').val() ) {
                    $('#save').removeClass('disabled');
                    $("#save").prop("disabled", false);
                }
            });
        },
        progressall: function (e, data) {
            var progress = parseInt(data.loaded / data.total * 100, 10);
            $('#progress .progress-bar').css(
                'width',
                progress + '%'
            );
        }
    }).prop('disabled', !$.support.fileInput)
        .parent().addClass($.support.fileInput ? undefined : 'disabled');
});
var current_select = '';
$('#import_format').change(function(){
    if ( current_select ) {
        $('.option-content').hide();
        if ($('#' + current_select + '-option').length) {
            $('#' + current_select + '-option').hide();
        }
    }
    if ( $(this).val() ) {
        if ( $('#magic').val() ) {
            $('#save').removeClass('disabled');
            $("#save").prop("disabled", false);
        }
        if ($('#' + $(this).val() + '-option').length) {
            $('#' + $(this).val() + '-option').show();
            $('.option-content').show();
        }
    }
    current_select = $(this).val();
});
$('#save').click(function(){
    if(!confirm('<mt:trans phrase="Are you sure you want to import entries?" component="EntryImporter">')){
        return false;
    }
    $(this).attr('disabled', true);
    $('#import-form').submit();
});
</script>
<mt:else>
<div id="print-area">
<div class="print-area-content">
<iframe id="print-area-iframe" src="<mt:var name="script_uri">?__mode=import_entry&amp;workspace_id=<mt:var name="workspace_id">&amp;magic_token=<mt:var name="magic_token">&amp;magic=<mt:var name="magic">&amp;import_format=<mt:var name="import_format"><mt:if name="import_options">&amp;<mt:var name="import_options" escape></mt:if>">
</iframe>
</div>
</div>
<script>
setInterval(function(){
    var iframe_ele = document.getElementById('print-area-iframe').contentWindow.document.documentElement;
    document.getElementById('print-area-iframe').contentWindow.scrollTo( 0, iframe_ele.scrollHeight );
},100);
</script>
</mt:unless>
<mt:include file="include/footer.tmpl">